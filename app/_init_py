"""
Application factory module.
Creates and configures the Flask application.
"""
from flask import Flask, jsonify, request, g
from flask_cors import CORS
from flask_talisman import Talisman
from werkzeug.middleware.proxy_fix import ProxyFix
import logging
import sys
import os
import time
from typing import Optional

from config import config
from app.extensions import (
    db, migrate, jwt, cache, limiter, socketio, celery,
    mail, talisman, cors, prometheus_metrics, sentry
)
from app.utils.logging import configure_logging
from app.errors import register_error_handlers
from app.api.v1 import api_bp
from app.cli import register_commands

# Import new blueprints (to be registered)
from app.api.v1 import (
    live_sessions, admissions, registrations, exams, financials,
    hostel, library, staff, alumni, curriculum
)


def create_app(config_name: Optional[str] = None) -> Flask:
    """
    Flask application factory.
    Args:
        config_name: The configuration to use (development, testing, production).
                     If None, determined by FLASK_ENV.
    Returns:
        Configured Flask application.
    """
    if config_name is None:
        config_name = os.environ.get('FLASK_ENV', 'development')

    app = Flask(__name__)
    app.config.from_object(config[config_name])

    # Set up logging first
    configure_logging(app)

    # Fix for proxies (important for HTTPS)
    app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_port=1)

    # Initialize extensions
    db.init_app(app)
    migrate.init_app(app, db)
    jwt.init_app(app)
    cache.init_app(app)
    limiter.init_app(app)
    socketio.init_app(app,
                      message_queue=app.config['SOCKETIO_MESSAGE_QUEUE'],
                      cors_allowed_origins=app.config['SOCKETIO_CORS_ALLOWED_ORIGINS'],
                      logger=app.debug,
                      engineio_logger=app.debug)
    celery.conf.update(app.config)
    mail.init_app(app)

    # Security headers with Talisman (CSP configurable)
    talisman.init_app(
        app,
        force_https=not app.debug,
        strict_transport_security=app.config['SECURITY_HEADERS'].get('Strict-Transport-Security'),
        session_cookie_secure=app.config['SESSION_COOKIE_SECURE'],
        session_cookie_http_only=app.config['SESSION_COOKIE_HTTPONLY'],
        session_cookie_samesite=app.config['SESSION_COOKIE_SAMESITE'],
        content_security_policy=app.config['CSP_POLICY'] if not app.debug else None,
        referrer_policy=app.config['SECURITY_HEADERS'].get('Referrer-Policy'),
        x_xss_protection=app.config['SECURITY_HEADERS'].get('X-XSS-Protection'),
    )

    # CORS
    CORS(app, resources={r"/api/*": {"origins": "*"}})

    # Sentry error tracking
    if app.config['SENTRY_DSN']:
        sentry.init_app(app, dsn=app.config['SENTRY_DSN'])

    # Prometheus metrics
    if app.config['PROMETHEUS_ENABLED']:
        prometheus_metrics.init_app(app)

    # Register error handlers
    register_error_handlers(app)

    # Register blueprints
    app.register_blueprint(api_bp, url_prefix='/api/v1')

    # Register new blueprints
    app.register_blueprint(live_sessions.bp, url_prefix='/api/v1/live-sessions')
    app.register_blueprint(admissions.bp, url_prefix='/api/v1/admissions')
    app.register_blueprint(registrations.bp, url_prefix='/api/v1/registrations')
    app.register_blueprint(exams.bp, url_prefix='/api/v1/exams')
    app.register_blueprint(financials.bp, url_prefix='/api/v1/financials')
    app.register_blueprint(hostel.bp, url_prefix='/api/v1/hostel')
    app.register_blueprint(library.bp, url_prefix='/api/v1/library')
    app.register_blueprint(staff.bp, url_prefix='/api/v1/staff')
    app.register_blueprint(alumni.bp, url_prefix='/api/v1/alumni')
    app.register_blueprint(curriculum.bp, url_prefix='/api/v1/curriculum')

    # Add health check endpoint (unprotected)
    @app.route('/health')
    def health():
        return jsonify({
            'status': 'ok',
            'environment': app.config.get('ENV', 'production'),
            'version': os.environ.get('VERSION', 'unknown')
        })

    # Add readiness probe
    @app.route('/ready')
    def ready():
        # Check database connectivity
        try:
            db.session.execute('SELECT 1')
            db.session.commit()
            return jsonify({'status': 'ready'})
        except Exception as e:
            app.logger.error(f"Readiness check failed: {e}")
            return jsonify({'status': 'unavailable'}), 503

    # CLI commands
    register_commands(app)

    # Before request: log request
    @app.before_request
    def before_request_logging():
        g.start_time = time.time()
        app.logger.info(f"Request: {request.method} {request.path}")

    # After request: log response time
    @app.after_request
    def after_request_logging(response):
        if hasattr(g, 'start_time'):
            duration = time.time() - g.start_time
            app.logger.info(f"Response: {response.status_code} - {duration:.3f}s")
            if app.config['PROMETHEUS_ENABLED']:
                prometheus_metrics.histogram('request_duration_seconds').observe(duration)
        return response

    app.logger.info(f"Application started in {config_name} mode")
    return app
